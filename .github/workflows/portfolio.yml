- name: Decide RUN_LABEL and gate to target IST windows
  run: |
    IST_HHMM=$(TZ=Asia/Kolkata date +%H%M)
    echo "IST_HHMM=$IST_HHMM"

    # Default: don't run
    echo "RUN_LABEL=SKIP" >> $GITHUB_ENV
    echo "SHOULD_RUN=0" >> $GITHUB_ENV

    # Manual always runs
    if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
      echo "RUN_LABEL=MANUAL" >> $GITHUB_ENV
      echo "SHOULD_RUN=1" >> $GITHUB_ENV
      exit 0
    fi

    # OPEN window: only check during 09:00–10:00 IST
    # Send once time is >= 09:20 IST
    if [ "$IST_HHMM" -ge 0900 ] && [ "$IST_HHMM" -le 1000 ]; then
      if [ "$IST_HHMM" -ge 0920 ]; then
        echo "RUN_LABEL=OPEN" >> $GITHUB_ENV
        echo "SHOULD_RUN=1" >> $GITHUB_ENV
      fi
      exit 0
    fi

    # CLOSE window: only check during 15:00–16:00 IST
    # Send once time is >= 15:20 IST
    if [ "$IST_HHMM" -ge 1500 ] && [ "$IST_HHMM" -le 1600 ]; then
      if [ "$IST_HHMM" -ge 1520 ]; then
        echo "RUN_LABEL=CLOSE" >> $GITHUB_ENV
        echo "SHOULD_RUN=1" >> $GITHUB_ENV
      fi
      exit 0
    fi
